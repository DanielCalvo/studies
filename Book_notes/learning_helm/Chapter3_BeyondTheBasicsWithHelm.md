## Chapter 3: Beyond the basics

There was some interesting theory here about what helm does when you ask it to install a chart and in which steps. Revisit if you feel you need this information

### dry-run
You can dry run:
```shell
helm install mysite bitnami/drupal --dry-run
```

Dry run will go through the first 4 steps of helm when you ask it to apply a chart:
- Load the chart, determine the values, render the templates, format to yaml

--dry-run is intended for you to debug the output of a chart before applying it to Kubernetes
--dry-run was also used to template the helm yaml to be piped into kubectl, but dry-run also mixes non-yaml output with the yaml. So the helm team created the template command!

### helm template
- The template command is designed to isolate the templating functionality of helm. 
- Helm template does not contact a k8s cluster to template, so it uses libraries to validate the types, as opposed to a cluster. This means that helm template cannot validate CRDs, as these are installed in a cluster

```shell
helm template mysite bitnami/drupal
```

You can specify a `--validate` flag, but in that case helm will need a kubeconfig file to connect to a cluster

There's a `--post-renderer` flag which you can use to send the yaml to some other tool, like Kustomize. Interesting, I should try that sometime.

You stopped on page 45 of the book index thing

### Releases
Let's go through the five phases of a helm installation real quick:
1. Load the chart
2. Parse the values
3. Execute the templates
4. Render the YAML
5. Send it to Kubernetes

```shell
helm install mysite bitnami/drupal --version 6.2.20
helm upgrade mysite bitnami/drupal --version 6.2.21
kubectl get secret
```

Each time you upgrade the mysite instalation, a new secret for it will be created
```shell
kubectl get secret sh.helm.release.v1.mysite.v3 -oyaml
```

The status of the above is deployed, but a helm release can be in one of many statuses:
- pending-install, deployed, pending-upgrade, superseded, pending-rollback, uninstalling, uninstalled, failed

### Listing releases
`helm list` is the best tool for checking the statuses of your releases

- `helm list` provides a summary view of the instalations

the `helm get` subcommands provide a more in depth information about a particular release
- `helm get notes mysite`
- `helm get values mysite --revision 2`<- Can be useful to troubleshoot by checking different values between releases
- `helm get values mysite` <- To see which values were provided during a release
- `helm get values wordpress --all` <- Shows all values for the chart. This includes ones that you didn't set when you installed the chart
- `helm inspect values bitnami/wordpress` <- Shows default configuration for chart
- `helm get manifest mysite` <- Fetches the generated manifest for a given release. Notes that this is not the current state, just the manifest

- `helm history mysite` <- Aha! This is what I was looking for, a revision history. Noice!
- `helm rollback mysite 2` <- Rollsback to version 2

Is it strongly recommended to NOT edit resources generated by helm by hand. You'll eventually be setting yourself for a ride later.

- You can:
- `helm uninstall wordpress --keep-history`
-  `helm rollback wordpress 1`
- If you uninstall a chart but keep its history, you can revert to when it was installed and have it back!

generate-name can generate a name for you:
`helm install bitnami/wordpress --generate-name`

If you pass a namespace that doesn't exist to helm, it will not install anything on that namespace (won't create it by default). You can request this namespace to be created however:
- `helm install drupalsito bitnami/drupal --namespace mynamespace --create-namespace`

You can use the helm upgrade command with the `--install` flag for it to install the chart if it does not exist, or to upgrade the release if it does exist. Useful in CI/CD pipelines
- `helm upgrade --install wordpress bitnami/wordpress --namespace mynamespace --create-namespace`

- Helm considers an operation a success as soon as the Kubernetes accepts the manifests. But this doesn't mean everything worked: You could have deployed a deployment with an image that does not exist, for instance.
- The `--wait` flag modifies this behaviour. This makes helm wait until:
1. The Kubernetes API accepts the manifests
2. All of the pods created by the chart reach the running state before Helm's timeout expires
- Maybe use it with a long timeout (5 to 10 minutes) to assume Kubernetes has time to make all the operations (like pull all the images), particularly in CI pipelines

The `--atomic` flag does the same, but instead of letting it fail (as the `--wait` flag would) it performs a rollback to the last succesfull release. Neat!

The `--force` flag modifies the behaviour of helm when it upgrades a resource that manages pods. For instance, changing certain fields in a Deployment doesn't mean it has to restart its pods.
With the force flag, instead of modifying a deployment, helm will recreate it (delete and apply again). This causes downtime!

If a chart fails to update, resources from the new chart might be left hanging. The `--cleanup-on-fail` flag makes sure these resources are deleted in case the release fails